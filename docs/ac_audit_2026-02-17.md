# AC Audit Report (2026-02-17)

Issue: `#5`  
Branch: `feat/issue-5-ac-rerun`

## AC採点表 (A-H)

| AC | Result | 根拠要約 |
|---|---|---|
| A 設定 | Pass | YAMLスキーマ検証、重複/不正URL検知、失敗通知経路あり |
| B 取得 | Pass | feedparserでRSS/Atom/RDF処理、title/link必須、日付fallback、全落ち通知あり |
| C フィルタ | Pass | required>=2、boost加点、exclude除外、決定的スコア、セット別上位制御、URL重複抑止 |
| D 永続化 | Pass | SQLite `items/deliveries`、URLキー再送防止、30日保持、障害通知経路あり |
| E メール | Pass | SMTP env検証、1実行1通の集約本文、行フォーマット固定、送信リトライあり |
| F Actions | Pass | cron(UTC22:00)、workflow_dispatch、Secrets注入、DB_PATH統一、ログ出力あり |
| G 運用 | Pass | README手順・.env.example・取得不可RSS記録・失敗ケース記載あり |
| H セキュリティ | Pass | Secrets値を直接ログ出力しない、URLはYAML管理、出典方針/本文非保存明記 |

## 根拠（ファイルパス + 行付近抜粋）

### A 設定
- `src/bid_rss_mailer/config.py:109`
```python
source_id = _require_str(raw, "id", node_path)
if source_id in seen_ids:
    raise ConfigError(f"Duplicate source id: {source_id}")
```
- `src/bid_rss_mailer/config.py:114`
```python
if not (url.startswith("http://") or url.startswith("https://")):
    raise ConfigError(f"{node_path}.url must start with http:// or https://")
normalized_url = normalize_url(url)
if normalized_url in seen_urls:
    raise ConfigError(f"Duplicate source url after normalization: {url}")
```
- `src/bid_rss_mailer/main.py:184`
```python
should_warn = bool(result.failures) or result.fetched_count == 0
if should_warn and not args.dry_run and settings.smtp_config is not None:
```

### B 取得
- `src/bid_rss_mailer/fetcher.py:74`
```python
parsed = feedparser.parse(response.content)
```
- `src/bid_rss_mailer/fetcher.py:81`
```python
title = (entry.get("title") or "").strip()
url = (entry.get("link") or entry.get("id") or "").strip()
if not title or not url:
    continue
```
- `src/bid_rss_mailer/fetcher.py:87`
```python
published_at = _parse_published(entry) or fetched_at
```
- `src/bid_rss_mailer/normalize.py:37`
```python
def normalize_url(url: str) -> str:
...
return urlunsplit((scheme, netloc, path, query, ""))
```
- `src/bid_rss_mailer/main.py:189`
```python
if result.fetched_count == 0:
    headline = "取得結果が0件です（全ソース失敗または全件欠損の可能性）。"
```

### C フィルタ
- `src/bid_rss_mailer/scorer.py:35`
```python
if len(required_matches) < keyword_set.min_required_matches:
    continue
```
- `src/bid_rss_mailer/scorer.py:41`
```python
if excluded_matches:
    has_exception = any(...)
    if not has_exception:
        continue
```
- `src/bid_rss_mailer/scorer.py:49`
```python
score = len(required_matches) * 10 + len(boost_matches) * 3
```
- `src/bid_rss_mailer/pipeline.py:68`
```python
return deduped_records[: keyword_set.top_n]
```
- `src/bid_rss_mailer/pipeline.py:61`
```python
seen_item_ids: set[int] = set()
...
if record.item_id in seen_item_ids:
    continue
```

### D 永続化
- `src/bid_rss_mailer/storage.py:12`
```sql
CREATE TABLE IF NOT EXISTS items (...);
CREATE TABLE IF NOT EXISTS deliveries (...);
```
- `src/bid_rss_mailer/storage.py:18`
```sql
url_key TEXT NOT NULL UNIQUE
```
- `src/bid_rss_mailer/storage.py:31`
```sql
UNIQUE(keyword_set_id, item_id)
```
- `src/bid_rss_mailer/storage.py:95`
```python
"DELETE FROM deliveries WHERE delivered_at < ?"
```
- `src/bid_rss_mailer/main.py:548`
```python
try:
    return args.handler(args)
except Exception as exc:
    ...
    _notify_failure(settings, traceback.format_exc())
```

### E メール
- `src/bid_rss_mailer/main.py:76`
```python
admin_email = (os.getenv("ADMIN_EMAIL") or "").strip()
...
missing = [key for key, value in {...} if not value]
```
- `src/bid_rss_mailer/pipeline.py:114`
```python
digest_subject = build_digest_subject(now_jst=now_jst)
digest_body = build_digest_body(...)
```
- `src/bid_rss_mailer/mailer.py:33`
```python
f"- {record.scored_item.score} | {item.title} | {item.organization} | "
f"{date_part}{deadline_part} | {item.url}"
```
- `src/bid_rss_mailer/mailer.py:92`
```python
max_attempts: int = 3
retry_wait_sec: float = 1.0
```

### F Actions
- `.github/workflows/daily-mail.yml:8`
```yaml
- cron: "0 22 * * *" # UTC 22:00 = JST 07:00
```
- `.github/workflows/daily-mail.yml:9`
```yaml
workflow_dispatch:
```
- `.github/workflows/daily-mail.yml:75`
```yaml
SECRET_ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
SECRET_SMTP_HOST: ${{ secrets.SMTP_HOST }}
...
```
- `.github/workflows/daily-mail.yml:83`
```bash
export DB_PATH="${GITHUB_WORKSPACE}/data/app.db"
```

### G 運用
- `README.md:108` `.env.example` からのセットアップ手順
- `README.md:393` 取得不可RSS記録へのリンク
- `README.md:383` 失敗ケース（RSS失敗/SMTP失敗）記載
- `.env.example:1` 必須/任意envのテンプレート提供

### H セキュリティ
- `.github/workflows/daily-mail.yml:75` Secrets参照で値をハードコードしない
- `data/sources.yaml:1` 取得URLをYAML管理
- `README.md:396`
```text
出典は各アイテムのURLリンクを参照し、本文全文は保存しません。
```

## Fail項目の最小修正タスク分解

- Fail項目なし（A-HすべてPass）。
- 追加修正は不要。検証ログ採取とIssue/PR反映のみ実施。

## ローカル実行Evidence

- `docs/evidence/issue5_local_pytest.log`
  - `39 passed`
- `docs/evidence/issue5_local_self_test.log`
  - `self-test: ok`
- `docs/evidence/issue5_local_run_dry.log`
  - `fetched=168 selected=28 failures=0 digest_sent=False recipients=1 dry_run=True`
- `docs/evidence/issue5_local_run_mock_smtp.log`
  - `fetched=168 selected=28 failures=0 digest_sent=True recipients=1 dry_run=False`

## Actions Evidence

- `ci`: (push run URLを追記)
- `daily-bid-rss-mail`: (push/workflow_dispatch run URLを追記)

