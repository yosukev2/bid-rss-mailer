name: x-publish-phase2

on:
  push:
    branches:
      - "feat/**"
    paths:
      - "src/bid_rss_mailer/main.py"
      - "src/bid_rss_mailer/x_publish.py"
      - "src/bid_rss_mailer/x_draft.py"
      - "src/bid_rss_mailer/storage.py"
      - ".github/workflows/x-publish.yml"
      - "README.md"
      - ".env.example"
      - "docs/ops/initial-acquisition.md"
  schedule:
    - cron: "10 22 * * *" # UTC 22:10 = JST 07:10
  workflow_dispatch:
    inputs:
      execution_mode:
        description: "dry_run / live"
        required: true
        default: "dry_run"
        type: choice
        options:
          - dry_run
          - live
      mode:
        description: "auto / webhook / x_api_v2 / manual"
        required: true
        default: "auto"
        type: choice
        options:
          - auto
          - webhook
          - x_api_v2
          - manual
      force:
        description: "overwrite same-day publish record"
        required: true
        default: false
        type: boolean
      on_missing_route:
        description: "fail / dry-run-success"
        required: true
        default: "fail"
        type: choice
        options:
          - fail
          - dry-run-success

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore SQLite cache
        uses: actions/cache@v4
        with:
          path: data/app.db
          key: bid-rss-mailer-db-${{ github.run_id }}
          restore-keys: |
            bid-rss-mailer-db-

      - name: Resolve execution plan
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            run_mode="${{ inputs.execution_mode }}"
            mode="${{ inputs.mode }}"
            force="${{ inputs.force }}"
            on_missing_route="${{ inputs.on_missing_route }}"
            fail_soft="false"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            run_mode="dry_run"
            mode="auto"
            force="true"
            on_missing_route="dry-run-success"
            fail_soft="true"
          else
            run_mode="${{ vars.X_PUBLISH_SCHEDULE_MODE || 'dry_run' }}"
            mode="${{ vars.X_PUBLISH_MODE || 'auto' }}"
            force="false"
            fail_soft="${{ vars.X_PUBLISH_SCHEDULE_FAIL_SOFT || 'true' }}"
            on_missing_route="fail"
            if [[ "$run_mode" == "live" && "$fail_soft" == "true" ]]; then
              on_missing_route="dry-run-success"
            fi
          fi
          echo "run_mode=$run_mode" >> "$GITHUB_OUTPUT"
          echo "mode=$mode" >> "$GITHUB_OUTPUT"
          echo "force=$force" >> "$GITHUB_OUTPUT"
          echo "on_missing_route=$on_missing_route" >> "$GITHUB_OUTPUT"
          echo "fail_soft=$fail_soft" >> "$GITHUB_OUTPUT"
          echo "execution_plan: event=${{ github.event_name }} run_mode=$run_mode mode=$mode force=$force on_missing_route=$on_missing_route fail_soft=$fail_soft"

      - name: Generate X draft (pre-step)
        shell: bash
        env:
          SECRET_LP_PUBLIC_URL: ${{ secrets.LP_PUBLIC_URL }}
          VAR_LP_PUBLIC_URL: ${{ vars.LP_PUBLIC_URL }}
        run: |
          set -euo pipefail
          export DB_PATH="${GITHUB_WORKSPACE}/data/app.db"
          export X_DRAFT_OUTPUT_DIR="${GITHUB_WORKSPACE}/out/x-drafts"
          export LP_PUBLIC_URL="${SECRET_LP_PUBLIC_URL:-${VAR_LP_PUBLIC_URL:-https://example.com/lp}}"

          cmd=(python -m bid_rss_mailer.main x-draft --db-path "$DB_PATH" --output-dir "$X_DRAFT_OUTPUT_DIR")
          if [[ "${{ steps.plan.outputs.force }}" == "true" ]]; then
            cmd+=(--force)
          fi
          PYTHONPATH=src "${cmd[@]}"

          ls -la "$X_DRAFT_OUTPUT_DIR"
          latest_file=$(ls -1t "$X_DRAFT_OUTPUT_DIR" | head -n 1)
          echo "latest_file=$latest_file"

      - name: Publish X draft
        shell: bash
        env:
          SECRET_X_WEBHOOK_URL: ${{ secrets.X_WEBHOOK_URL }}
          VAR_X_WEBHOOK_URL: ${{ vars.X_WEBHOOK_URL }}
          SECRET_X_USER_ACCESS_TOKEN: ${{ secrets.X_USER_ACCESS_TOKEN }}
          SECRET_X_API_BEARER_TOKEN: ${{ secrets.X_API_BEARER_TOKEN }}
        run: |
          set -euo pipefail
          export DB_PATH="${GITHUB_WORKSPACE}/data/app.db"
          export X_DRAFT_OUTPUT_DIR="${GITHUB_WORKSPACE}/out/x-drafts"
          export X_WEBHOOK_URL="${SECRET_X_WEBHOOK_URL:-${VAR_X_WEBHOOK_URL:-}}"
          export X_USER_ACCESS_TOKEN="${SECRET_X_USER_ACCESS_TOKEN:-}"
          export X_API_BEARER_TOKEN="${SECRET_X_API_BEARER_TOKEN:-}"

          cmd=(python -m bid_rss_mailer.main x-publish --db-path "$DB_PATH" --draft-dir "$X_DRAFT_OUTPUT_DIR" --receipt-dir "$GITHUB_WORKSPACE/out/x-publish" --mode "${{ steps.plan.outputs.mode }}" --on-missing-route "${{ steps.plan.outputs.on_missing_route }}")
          if [[ "${{ steps.plan.outputs.force }}" == "true" ]]; then
            cmd+=(--force)
          fi
          if [[ "${{ steps.plan.outputs.run_mode }}" == "live" ]]; then
            cmd+=(--live)
          else
            cmd+=(--dry-run)
          fi

          set +e
          PYTHONPATH=src "${cmd[@]}" 2>&1 | tee publish.log
          status="$?"
          set -e

          if [[ "$status" -eq 2 && "${{ steps.plan.outputs.fail_soft }}" == "true" ]]; then
            echo "live configuration incomplete; fallback to dry-run"
            fallback=(python -m bid_rss_mailer.main x-publish --db-path "$DB_PATH" --draft-dir "$X_DRAFT_OUTPUT_DIR" --receipt-dir "$GITHUB_WORKSPACE/out/x-publish" --mode auto --dry-run --on-missing-route dry-run-success)
            if [[ "${{ steps.plan.outputs.force }}" == "true" ]]; then
              fallback+=(--force)
            fi
            PYTHONPATH=src "${fallback[@]}" 2>&1 | tee -a publish.log
            status="$?"
          fi

          if [[ "$status" -ne 0 ]]; then
            exit "$status"
          fi

          ls -la "$GITHUB_WORKSPACE/out/x-publish"
          latest_receipt=$(ls -1t "$GITHUB_WORKSPACE/out/x-publish" | head -n 1)
          echo "latest_receipt=$latest_receipt"
          echo "-----"
          cat "$GITHUB_WORKSPACE/out/x-publish/$latest_receipt"

      - name: Upload publish artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: x-publish-output
          path: |
            out/x-drafts
            out/x-publish
            publish.log
